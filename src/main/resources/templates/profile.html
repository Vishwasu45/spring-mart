<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout}">

<head>
    <title>My Profile - SpringMart</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="container my-5">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-lg-3 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body text-center">
                            <div class="mb-3">
                                <img th:src="${user.imageUrl != null ? user.imageUrl : 'https://ui-avatars.com/api/?name=' + user.name + '&background=random'}"
                                    class="rounded-circle img-thumbnail" alt="Profile Picture"
                                    style="width: 100px; height: 100px; object-fit: cover;">
                            </div>
                            <h5 class="card-title" th:text="${user.name}">User Name</h5>
                            <p class="text-muted small" th:text="${user.email}">user@example.com</p>
                            <span th:each="role : ${user.roles}" class="badge bg-primary me-1"
                                th:text="${role}">USER</span>
                        </div>
                        <div class="list-group list-group-flush" id="profileTabs" role="tablist">
                            <a class="list-group-item list-group-item-action active" id="info-tab" data-bs-toggle="list"
                                href="#info" role="tab">
                                <i class="bi bi-person me-2"></i> Profile Information
                            </a>
                            <a href="/orders" class="list-group-item list-group-item-action">
                                <i class="bi bi-box-seam me-2"></i> My Orders
                            </a>
                            <a class="list-group-item list-group-item-action" id="addresses-tab" data-bs-toggle="list"
                                href="#addresses" role="tab">
                                <i class="bi bi-geo-alt me-2"></i> Addresses
                            </a>
                            <a class="list-group-item list-group-item-action" id="payments-tab" data-bs-toggle="list"
                                href="#payments" role="tab">
                                <i class="bi bi-credit-card me-2"></i> Payment Methods
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-lg-9">
                    <div class="tab-content" id="profileTabsContent">
                        <!-- Profile Info Tab -->
                        <div class="tab-pane fade show active" id="info" role="tabpanel">
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-white py-3">
                                    <h5 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i> Profile Information
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label text-muted">Full Name</label>
                                                <input type="text" class="form-control" th:value="${user.name}"
                                                    readonly>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label text-muted">Email Address</label>
                                                <input type="email" class="form-control" th:value="${user.email}"
                                                    readonly>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label text-muted">Phone Number</label>
                                                <input type="text" class="form-control" value="Not provided" readonly>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label text-muted">Member Since</label>
                                                <input type="text" class="form-control"
                                                    th:value="${#temporals.format(user.createdAt, 'MMM dd, yyyy')}"
                                                    readonly>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <div class="card shadow-sm">
                                <div
                                    class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i> Account Security</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <h6 class="mb-1">Password</h6>
                                            <p class="text-muted small mb-0">Last changed: Never</p>
                                        </div>
                                        <button class="btn btn-outline-secondary btn-sm" disabled>Change
                                            Password</button>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">Two-Factor Authentication</h6>
                                            <p class="text-muted small mb-0">Add an extra layer of security to your
                                                account</p>
                                        </div>
                                        <button class="btn btn-outline-secondary btn-sm" disabled>Enable</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Addresses Tab -->
                        <div class="tab-pane fade" id="addresses" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="mb-0">My Addresses</h4>
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#addAddressModal">
                                    <i class="bi bi-plus-lg"></i> Add New Address
                                </button>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3" th:each="address : ${addresses}">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="card-title mb-0">
                                                    <i class="bi bi-house-door"></i>
                                                    <span th:if="${address.default}"
                                                        class="badge bg-success ms-2">Default</span>
                                                </h6>
                                                <button class="btn btn-link text-danger p-0"
                                                    th:onclick="'deleteAddress(' + ${address.id} + ')'">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                            <p class="card-text mb-1" th:text="${address.street}">123 Main St</p>
                                            <p class="card-text mb-1">
                                                <span th:text="${address.city}">City</span>,
                                                <span th:text="${address.state}">State</span>
                                                <span th:text="${address.zipCode}">12345</span>
                                            </p>
                                            <p class="card-text text-muted small" th:text="${address.country}">Country
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12" th:if="${addresses.empty}">
                                    <div class="alert alert-light text-center">
                                        No addresses saved yet.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Methods Tab -->
                        <div class="tab-pane fade" id="payments" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="mb-0">Payment Methods</h4>
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#addCardModal">
                                    <i class="bi bi-plus-lg"></i> Add New Card
                                </button>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3" th:each="card : ${cards}">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <h5 class="card-title mb-0">
                                                    <i class="bi bi-credit-card-2-front"></i>
                                                    <span th:text="${card.brand}">Visa</span>
                                                    <span th:if="${card.default}"
                                                        class="badge bg-success ms-2">Default</span>
                                                </h5>
                                                <button class="btn btn-link text-danger p-0"
                                                    th:onclick="'deleteCard(' + ${card.id} + ')'">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                            <p class="card-text mb-1">
                                                **** **** **** <span th:text="${card.last4}">1234</span>
                                            </p>
                                            <p class="card-text text-muted small">
                                                Expires: <span th:text="${card.expiryMonth}">12</span>/<span
                                                    th:text="${card.expiryYear}">25</span>
                                            </p>
                                            <p class="card-text text-muted small" th:text="${card.holderName}">John Doe
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12" th:if="${cards.empty}">
                                    <div class="alert alert-light text-center">
                                        No payment methods saved yet.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Add Address Modal -->
        <div class="modal fade" id="addAddressModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Address</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addAddressForm">
                            <div class="mb-3">
                                <label class="form-label">Street Address</label>
                                <textarea class="form-control" name="street" required></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-control" name="city" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">State</label>
                                    <input type="text" class="form-control" name="state" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ZIP Code</label>
                                    <input type="text" class="form-control" name="zipCode" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Country</label>
                                    <input type="text" class="form-control" name="country" required>
                                </div>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" name="isDefault" id="defaultAddress">
                                <label class="form-check-label" for="defaultAddress">Set as default address</label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveAddress()">Save Address</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Card Modal -->
        <div class="modal fade" id="addCardModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Card</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addCardForm">
                            <div class="mb-3">
                                <label class="form-label">Card Number</label>
                                <input type="text" class="form-control" id="cardNumberInput" maxlength="19"
                                    placeholder="xxxx xxxx xxxx xxxx" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Expiry (MM/YY)</label>
                                    <input type="text" class="form-control" id="cardExpiryInput" maxlength="5"
                                        placeholder="MM/YY" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">CVC</label>
                                    <input type="text" class="form-control" maxlength="4" placeholder="123" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Cardholder Name</label>
                                <input type="text" class="form-control" name="holderName" required>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" name="isDefault" id="defaultCard">
                                <label class="form-check-label" for="defaultCard">Set as default payment method</label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveCard()">Save Card</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="scripts">
        <script>
            // Format Card Inputs
            document.getElementById('cardNumberInput').addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/(.{4})/g, '$1 ').trim();
                e.target.value = value;
            });

            document.getElementById('cardExpiryInput').addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                }
                e.target.value = value;
            });

            function saveAddress() {
                const form = document.getElementById('addAddressForm');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                data.isDefault = document.getElementById('defaultAddress').checked;

                fetch('/api/profile/addresses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                    .then(response => {
                        if (response.ok) window.location.reload();
                        else alert('Failed to save address');
                    });
            }

            function deleteAddress(id) {
                if (confirm('Are you sure you want to delete this address?')) {
                    fetch('/api/profile/addresses/' + id, { method: 'DELETE' })
                        .then(response => {
                            if (response.ok) window.location.reload();
                            else alert('Failed to delete address');
                        });
                }
            }

            function saveCard() {
                const cardNumber = document.getElementById('cardNumberInput').value.replace(/\s/g, '');
                const expiry = document.getElementById('cardExpiryInput').value.split('/');
                const holderName = document.querySelector('input[name="holderName"]').value;
                const isDefault = document.getElementById('defaultCard').checked;

                if (cardNumber.length < 15 || expiry.length !== 2) {
                    alert('Invalid card details');
                    return;
                }

                const data = {
                    last4: cardNumber.slice(-4),
                    brand: getCardBrand(cardNumber),
                    expiryMonth: expiry[0],
                    expiryYear: expiry[1],
                    holderName: holderName,
                    isDefault: isDefault
                };

                fetch('/api/profile/cards', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                    .then(response => {
                        if (response.ok) window.location.reload();
                        else alert('Failed to save card');
                    });
            }

            function deleteCard(id) {
                if (confirm('Are you sure you want to delete this card?')) {
                    fetch('/api/profile/cards/' + id, { method: 'DELETE' })
                        .then(response => {
                            if (response.ok) window.location.reload();
                            else alert('Failed to delete card');
                        });
                }
            }

            function getCardBrand(number) {
                if (number.startsWith('4')) return 'Visa';
                if (number.startsWith('5')) return 'Mastercard';
                if (number.startsWith('3')) return 'Amex';
                return 'Card';
            }
        </script>
    </th:block>
</body>

</html>