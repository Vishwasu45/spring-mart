<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security" layout:decorate="~{layout}">

<head>
    <title th:text="${product.name} + ' - SpringMart'">Product Detail</title>
</head>

<body>
    <div layout:fragment="content">
        <!-- Breadcrumb & Header -->
        <div class="bg-light py-4 mb-5">
            <div class="container">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Home</a></li>
                        <li class="breadcrumb-item"><a href="/products" class="text-decoration-none">Products</a></li>
                        <li class="breadcrumb-item active" aria-current="page" th:text="${product.name}">Product</li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="container mb-5">
            <div class="row g-5">
                <!-- Product Images -->
                <div class="col-lg-6">
                    <div class="position-relative mb-4">
                        <div class="ratio ratio-4x3 rounded-4 overflow-hidden shadow-sm bg-white">
                            <img th:src="${product.primaryImageUrl != null ? product.primaryImageUrl : 'https://via.placeholder.com/600x400?text=' + product.name}"
                                class="object-fit-cover" th:alt="${product.name}" id="mainImage">
                        </div>
                        <span
                            class="position-absolute top-0 start-0 m-4 badge bg-danger rounded-pill px-3 py-2 shadow-sm"
                            th:if="${product.discountPercentage > 0}">
                            -<span th:text="${product.discountPercentage}">20</span>% OFF
                        </span>
                    </div>

                    <!-- Thumbnail Gallery (Placeholder) -->
                    <div class="row g-2">
                        <div class="col-3">
                            <div
                                class="ratio ratio-1x1 rounded-3 overflow-hidden cursor-pointer border border-primary border-2">
                                <img th:src="${product.primaryImageUrl != null ? product.primaryImageUrl : 'https://via.placeholder.com/150'}"
                                    class="object-fit-cover" alt="Thumbnail 1">
                            </div>
                        </div>
                        <!-- Additional placeholders for gallery -->
                        <div class="col-3" th:each="i : ${#numbers.sequence(1, 3)}">
                            <div
                                class="ratio ratio-1x1 rounded-3 overflow-hidden cursor-pointer border border-light hover-border-primary transition-all">
                                <img th:src="'https://via.placeholder.com/150?text=Image+' + ${i}"
                                    class="object-fit-cover" th:alt="'Thumbnail ' + ${i}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Info -->
                <div class="col-lg-6">
                    <div class="ps-lg-4">
                        <div class="mb-3">
                            <span
                                class="badge bg-primary-subtle text-primary border border-primary-subtle rounded-pill px-3 py-2"
                                th:text="${product.categoryName}">Category</span>
                            <span
                                class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3 py-2 ms-2"
                                th:if="${product.stockQuantity > 0}">In Stock</span>
                            <span
                                class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill px-3 py-2 ms-2"
                                th:unless="${product.stockQuantity > 0}">Out of Stock</span>
                        </div>

                        <h1 class="display-5 fw-bold mb-3" th:text="${product.name}">Product Name</h1>

                        <div class="d-flex align-items-center mb-4">
                            <div class="d-flex text-warning me-3">
                                <i class="bi bi-star-fill" th:each="i : ${#numbers.sequence(1, 5)}"
                                    th:class="${i <= product.averageRating} ? 'bi bi-star-fill' : 'bi bi-star'"></i>
                            </div>
                            <span class="text-muted border-start ps-3" th:text="${product.reviewCount + ' Reviews'}">120
                                Reviews</span>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex align-items-end gap-3">
                                <h2 class="display-6 fw-bold text-primary mb-0"
                                    th:if="${product.discountPercentage == 0}" th:text="'$' + ${product.price}">$99.99
                                </h2>
                                <div th:if="${product.discountPercentage > 0}" class="d-flex align-items-end gap-3">
                                    <h2 class="display-6 fw-bold text-danger mb-0"
                                        th:text="'$' + ${#numbers.formatDecimal(product.price * (100 - product.discountPercentage) / 100, 1, 2)}">
                                        $79.99</h2>
                                    <span class="text-muted text-decoration-line-through fs-4 mb-1"
                                        th:text="'$' + ${product.price}">$99.99</span>
                                </div>
                            </div>
                            <p class="text-muted small mt-1">Includes all taxes and fees</p>
                        </div>

                        <p class="lead text-muted mb-5" th:text="${product.description}">
                            Product description goes here. This is a detailed description of the product features and
                            benefits.
                        </p>

                        <!-- Add to Cart Section -->
                        <div class="card bg-light border-0 rounded-4 p-4 mb-4">
                            <div sec:authorize="!isAuthenticated()">
                                <div class="text-center">
                                    <p class="mb-3">Please login to purchase this item</p>
                                    <a href="/login" class="btn btn-primary btn-lg rounded-pill px-5">
                                        <i class="bi bi-box-arrow-in-right me-2"></i> Login to Buy
                                    </a>
                                </div>
                            </div>

                            <div sec:authorize="isAuthenticated()">
                                <form th:action="@{/cart/add}" method="post" id="addToCartForm">
                                    <input type="hidden" name="productId" th:value="${product.id}">

                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">Quantity</label>
                                            <div class="input-group">
                                                <button class="btn btn-outline-secondary" type="button"
                                                    onclick="decrementQuantity()">-</button>
                                                <input type="number" name="quantity" id="quantityInput" value="1"
                                                    min="1" th:max="${product.stockQuantity}"
                                                    class="form-control text-center border-secondary">
                                                <button class="btn btn-outline-secondary" type="button"
                                                    onclick="incrementQuantity()">+</button>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="d-flex gap-2">
                                                <button type="submit" class="btn btn-primary btn-lg flex-grow-1 rounded-pill"
                                                    th:disabled="${product.stockQuantity <= 0}">
                                                    <i class="bi bi-cart-plus me-2"></i> Add to Cart
                                                </button>
                                                <button type="button" sec:authorize="isAuthenticated()" 
                                                    class="btn btn-outline-primary btn-lg rounded-circle wishlist-detail-btn" 
                                                    style="width: 54px; height: 54px; padding: 0;"
                                                    th:attr="data-product-id=${product.id}"
                                                    onclick="toggleWishlist(this.dataset.productId, this.querySelector('i'))">
                                                    <i class="bi bi-heart fs-5"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Additional Info -->
                        <div class="row g-4 text-center border-top pt-4">
                            <div class="col-4">
                                <div class="p-2">
                                    <i class="bi bi-truck text-primary fs-4 mb-2 d-block"></i>
                                    <span class="small fw-bold">Free Shipping</span>
                                </div>
                            </div>
                            <div class="col-4 border-start border-end">
                                <div class="p-2">
                                    <i class="bi bi-shield-check text-primary fs-4 mb-2 d-block"></i>
                                    <span class="small fw-bold">2 Year Warranty</span>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-2">
                                    <i class="bi bi-arrow-repeat text-primary fs-4 mb-2 d-block"></i>
                                    <span class="small fw-bold">30 Days Return</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Details Tabs -->
            <div class="row mt-5">
                <div class="col-12">
                    <ul class="nav nav-pills mb-4 justify-content-center" id="productTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active rounded-pill px-4" id="description-tab" data-bs-toggle="tab"
                                data-bs-target="#description" type="button" role="tab">Description</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link rounded-pill px-4" id="specs-tab" data-bs-toggle="tab"
                                data-bs-target="#specs" type="button" role="tab">Specifications</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link rounded-pill px-4" id="reviews-tab" data-bs-toggle="tab"
                                data-bs-target="#reviews" type="button" role="tab">Reviews</button>
                        </li>
                    </ul>
                    <div class="tab-content p-4 bg-light rounded-4" id="productTabContent">
                        <div class="tab-pane fade show active" id="description" role="tabpanel">
                            <h4 class="fw-bold mb-3">Product Description</h4>
                            <p th:text="${product.description}">Full product description...</p>
                        </div>
                        <div class="tab-pane fade" id="specs" role="tabpanel">
                            <h4 class="fw-bold mb-3">Technical Specifications</h4>
                            <table class="table table-borderless">
                                <tbody>
                                    <tr>
                                        <td class="text-muted w-25">SKU</td>
                                        <td class="fw-bold" th:text="${product.sku}">SKU123</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Seller</td>
                                        <td class="fw-bold" th:text="${product.sellerName}">Seller Name</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Category</td>
                                        <td class="fw-bold" th:text="${product.categoryName}">Category</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane fade" id="reviews" role="tabpanel">
                            <h4 class="fw-bold mb-4">Customer Reviews</h4>
                            
                            <!-- Review Summary -->
                            <div class="row mb-4 pb-4 border-bottom">
                                <div class="col-md-4 text-center">
                                    <h2 class="display-4 fw-bold mb-2" id="avgRating">0.0</h2>
                                    <div class="d-flex justify-content-center text-warning mb-2" id="avgStars">
                                        <i class="bi bi-star me-1"></i>
                                        <i class="bi bi-star me-1"></i>
                                        <i class="bi bi-star me-1"></i>
                                        <i class="bi bi-star me-1"></i>
                                        <i class="bi bi-star"></i>
                                    </div>
                                    <p class="text-muted mb-0"><span id="reviewCount">0</span> Reviews</p>
                                </div>
                                <div class="col-md-8">
                                    <div class="mb-2" th:each="star : ${#numbers.sequence(5, 1, -1)}">
                                        <div class="d-flex align-items-center">
                                            <span class="text-muted me-2" th:text="${star} + ' star'"></span>
                                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                                <div class="progress-bar bg-warning" role="progressbar" 
                                                     th:style="'width: 0%'" th:attr="data-star=${star}"></div>
                                            </div>
                                            <span class="text-muted small rating-count" th:attr="data-star=${star}">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Write Review Button (for authenticated users who haven't reviewed) -->
                            <div sec:authorize="isAuthenticated()" id="writeReviewSection" style="display: none;">
                                <button class="btn btn-primary rounded-pill mb-4" data-bs-toggle="collapse" 
                                        data-bs-target="#reviewForm">
                                    <i class="bi bi-pencil-square me-2"></i> Write a Review
                                </button>
                                
                                <!-- Review Form -->
                                <div class="collapse mb-4" id="reviewForm">
                                    <div class="card border-0 shadow-sm rounded-4">
                                        <div class="card-body p-4">
                                            <h5 class="card-title mb-3">Share Your Experience</h5>
                                            <form id="submitReviewForm">
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Rating *</label>
                                                    <div class="star-rating" id="starRating">
                                                        <i class="bi bi-star fs-4 me-1" data-rating="1"></i>
                                                        <i class="bi bi-star fs-4 me-1" data-rating="2"></i>
                                                        <i class="bi bi-star fs-4 me-1" data-rating="3"></i>
                                                        <i class="bi bi-star fs-4 me-1" data-rating="4"></i>
                                                        <i class="bi bi-star fs-4" data-rating="5"></i>
                                                    </div>
                                                    <input type="hidden" id="ratingInput" name="rating" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="reviewComment" class="form-label fw-bold">Your Review</label>
                                                    <textarea class="form-control" id="reviewComment" name="comment" 
                                                              rows="4" maxlength="1000" 
                                                              placeholder="Tell us what you think about this product..."></textarea>
                                                    <div class="form-text">Optional - Maximum 1000 characters</div>
                                                </div>
                                                <div class="d-flex gap-2">
                                                    <button type="submit" class="btn btn-primary rounded-pill">
                                                        <i class="bi bi-send me-2"></i> Submit Review
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary rounded-pill" 
                                                            data-bs-toggle="collapse" data-bs-target="#reviewForm">
                                                        Cancel
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Login prompt for unauthenticated users -->
                            <div sec:authorize="!isAuthenticated()" class="alert alert-info rounded-4 mb-4">
                                <i class="bi bi-info-circle me-2"></i>
                                <a href="/login" class="alert-link">Login</a> to write a review
                            </div>

                            <!-- Already reviewed message -->
                            <div id="alreadyReviewedMsg" class="alert alert-success rounded-4 mb-4" style="display: none;">
                                <i class="bi bi-check-circle me-2"></i> You have already reviewed this product
                            </div>

                            <!-- Reviews List -->
                            <div id="reviewsList">
                                <div class="text-center py-5" id="noReviewsMsg">
                                    <i class="bi bi-chat-square-text text-muted fs-1 mb-3"></i>
                                    <p class="text-muted">No reviews yet. Be the first to review this product!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- You May Also Like Section -->
    <div class="container my-5" id="recommendationsSection" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold">You May Also Like</h3>
        </div>
        <div class="row g-4" id="recommendationsList"></div>
    </div>

    <script layout:fragment="script" th:inline="javascript">
        const productId = [[${product.id}]];
        let selectedRating = 0;

        function incrementQuantity() {
            const input = document.getElementById('quantityInput');
            const max = parseInt(input.getAttribute('max'));
            let value = parseInt(input.value);
            if (value < max) {
                input.value = value + 1;
            }
        }

        function decrementQuantity() {
            const input = document.getElementById('quantityInput');
            let value = parseInt(input.value);
            if (value > 1) {
                input.value = value - 1;
            }
        }

        // Star Rating Click Handler
        document.addEventListener('DOMContentLoaded', function() {
            const stars = document.querySelectorAll('#starRating i');

            // Load similar products
            loadSimilarProducts();
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    document.getElementById('ratingInput').value = selectedRating;
                    updateStarDisplay(stars, selectedRating);
                });

                star.addEventListener('mouseenter', function() {
                    const hoverRating = parseInt(this.dataset.rating);
                    updateStarDisplay(stars, hoverRating);
                });
            });

            document.getElementById('starRating').addEventListener('mouseleave', function() {
                updateStarDisplay(stars, selectedRating);
            });

            // Check if user has reviewed
            checkUserReview();

            // Load reviews
            loadReviews();

            // Submit review form
            document.getElementById('submitReviewForm').addEventListener('submit', submitReview);

            // Check wishlist status for this product
            const wishlistBtn = document.querySelector('.wishlist-detail-btn');
            if (wishlistBtn) {
                checkWishlistStatus(productId, wishlistBtn.querySelector('i'));
            }
        });

        async function checkWishlistStatus(productId, heartIcon) {
            try {
                const response = await fetch(`/api/wishlist/check/${productId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.inWishlist && heartIcon) {
                        heartIcon.classList.remove('bi-heart');
                        heartIcon.classList.add('bi-heart-fill', 'text-danger');
                    }
                }
            } catch (error) {
                console.error('Error checking wishlist status:', error);
            }
        }

        function updateStarDisplay(stars, rating) {
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('bi-star');
                    star.classList.add('bi-star-fill', 'text-warning');
                } else {
                    star.classList.remove('bi-star-fill', 'text-warning');
                    star.classList.add('bi-star');
                }
            });
        }

        async function checkUserReview() {
            try {
                const response = await fetch(`/api/reviews/product/${productId}/check`);
                const data = await response.json();
                
                if (data.hasReviewed) {
                    document.getElementById('alreadyReviewedMsg').style.display = 'block';
                } else {
                    document.getElementById('writeReviewSection').style.display = 'block';
                }
            } catch (error) {
                console.error('Error checking review status:', error);
            }
        }

        async function loadReviews() {
            try {
                const response = await fetch(`/api/reviews/product/${productId}/all`);
                const reviews = await response.json();
                
                if (reviews.length === 0) {
                    document.getElementById('noReviewsMsg').style.display = 'block';
                    return;
                }

                document.getElementById('noReviewsMsg').style.display = 'none';
                displayReviews(reviews);
                updateReviewStats(reviews);
            } catch (error) {
                console.error('Error loading reviews:', error);
            }
        }

        function displayReviews(reviews) {
            const reviewsList = document.getElementById('reviewsList');
            reviewsList.innerHTML = '';

            reviews.forEach(review => {
                const reviewCard = `
                    <div class="card border-0 shadow-sm rounded-4 mb-3">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">${escapeHtml(review.userName)}</h6>
                                    <small class="text-muted">${formatDate(review.createdAt)}</small>
                                </div>
                                <div class="d-flex text-warning">
                                    ${generateStars(review.rating)}
                                </div>
                            </div>
                            ${review.comment ? `<p class="mb-0">${escapeHtml(review.comment)}</p>` : ''}
                        </div>
                    </div>
                `;
                reviewsList.innerHTML += reviewCard;
            });
        }

        function updateReviewStats(reviews) {
            const total = reviews.length;
            document.getElementById('reviewCount').textContent = total;

            // Calculate average
            const sum = reviews.reduce((acc, r) => acc + r.rating, 0);
            const avg = (sum / total).toFixed(1);
            document.getElementById('avgRating').textContent = avg;

            // Update average stars
            const avgStarsContainer = document.getElementById('avgStars');
            avgStarsContainer.innerHTML = generateStars(Math.round(avg));

            // Calculate rating distribution
            const distribution = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
            reviews.forEach(r => distribution[r.rating]++);

            // Update progress bars
            for (let star = 1; star <= 5; star++) {
                const count = distribution[star];
                const percentage = (count / total * 100).toFixed(0);
                const progressBar = document.querySelector(`.progress-bar[data-star="${star}"]`);
                const countSpan = document.querySelector(`.rating-count[data-star="${star}"]`);
                
                if (progressBar) progressBar.style.width = percentage + '%';
                if (countSpan) countSpan.textContent = count;
            }
        }

        function generateStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += i <= rating ? 
                    '<i class="bi bi-star-fill me-1"></i>' : 
                    '<i class="bi bi-star me-1"></i>';
            }
            return stars;
        }

        async function submitReview(e) {
            e.preventDefault();

            if (selectedRating === 0) {
                alert('Please select a rating');
                return;
            }

            const comment = document.getElementById('reviewComment').value.trim();
            
            const reviewData = {
                productId: productId,
                rating: selectedRating,
                comment: comment || null
            };

            try {
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(reviewData)
                });

                if (response.ok) {
                    // Success
                    alert('Thank you for your review!');
                    document.getElementById('submitReviewForm').reset();
                    selectedRating = 0;
                    updateStarDisplay(document.querySelectorAll('#starRating i'), 0);
                    
                    // Hide write review section
                    document.getElementById('writeReviewSection').style.display = 'none';
                    document.getElementById('alreadyReviewedMsg').style.display = 'block';
                    
                    // Collapse form
                    const collapseElement = document.getElementById('reviewForm');
                    const bsCollapse = bootstrap.Collapse.getInstance(collapseElement);
                    if (bsCollapse) bsCollapse.hide();
                    
                    // Reload reviews
                    loadReviews();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to submit review');
                }
            } catch (error) {
                console.error('Error submitting review:', error);
                alert('Failed to submit review. Please try again.');
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadSimilarProducts() {
            try {
                const response = await fetch(`/api/recommendations/similar/${productId}?limit=4`);
                const products = await response.json();

                if (products && products.length > 0) {
                    const recommendationsSection = document.getElementById('recommendationsSection');
                    const recommendationsList = document.getElementById('recommendationsList');
                    
                    recommendationsList.innerHTML = products.map(product => `
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm h-100 rounded-4 product-card">
                                <a href="/products/${product.slug}" class="text-decoration-none">
                                    <img src="${product.primaryImageUrl || '/images/placeholder.jpg'}" 
                                         class="card-img-top rounded-top-4" 
                                         alt="${product.name}"
                                         style="height: 200px; object-fit: cover;">
                                </a>
                                <div class="card-body p-3">
                                    <a href="/products/${product.slug}" class="text-decoration-none">
                                        <h6 class="card-title fw-semibold text-dark mb-2" style="min-height: 48px;">
                                            ${product.name}
                                        </h6>
                                    </a>
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="text-warning me-2">
                                            ${'★'.repeat(Math.floor(product.averageRating || 0))}${'☆'.repeat(5 - Math.floor(product.averageRating || 0))}
                                        </div>
                                        <small class="text-muted">(${product.reviewCount || 0})</small>
                                    </div>
                                    <h5 class="text-primary fw-bold mb-3">$${product.price.toFixed(2)}</h5>
                                    <button onclick="addToCartFromRecommendation(${product.id}, event)" 
                                            class="btn btn-outline-primary w-100 rounded-pill btn-sm">
                                        <i class="bi bi-cart-plus me-1"></i> Add to Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');

                    recommendationsSection.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading recommendations:', error);
            }
        }

        function addToCartFromRecommendation(productId, event) {
            event.preventDefault();
            event.stopPropagation();
            
            fetch('/api/cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productId: productId, quantity: 1 })
            })
            .then(response => {
                if (response.ok) {
                    alert('Product added to cart!');
                    location.reload();
                } else {
                    alert('Failed to add product to cart');
                }
            })
            .catch(error => {
                console.error('Error adding to cart:', error);
                alert('Failed to add product to cart');
            });
        }
    </script>
</body>

</html>